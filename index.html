<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SkiSpecAI Chat</title>
    <style>
      :root {
        --bg: #f6f8fc;
        --card: #ffffff;
        --border: #e6e9f2;
        --text: #111827;
        --muted: #6b7280;
        --accent: #2563eb; /* blue */
        --accent-2: #7c3aed; /* purple */
        --you: #2563eb;
        --youText: #ffffff;
        --bot: #f3f4f6;
        --botText: #111827;
        --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(
            1200px 600px at 20% 10%,
            rgba(37, 99, 235, 0.12),
            transparent 60%
          ),
          radial-gradient(
            1000px 500px at 80% 0%,
            rgba(124, 58, 237, 0.10),
            transparent 55%
          ),
          var(--bg);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2.5rem 1rem;
        color: var(--text);
      }

      #container {
        width: 100%;
        max-width: 960px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* Header */
      #header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(
          90deg,
          rgba(37, 99, 235, 0.08),
          rgba(124, 58, 237, 0.06)
        );
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      #title {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      #title h1 {
        font-size: 1.1rem;
        letter-spacing: 0.2px;
      }

      #title p {
        font-size: 0.9rem;
        color: var(--muted);
      }

      #header-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .btn {
        padding: 0.6rem 0.85rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        font-size: 0.85rem;
        cursor: pointer;
        transition: transform 0.05s ease, background 0.15s ease;
      }

      .btn:hover {
        background: #fafafa;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn.primary {
        border: none;
        background: var(--accent);
        color: #fff;
      }

      .btn.primary:hover {
        background: #1d4ed8;
      }

      /* Messages */
      #messages {
        padding: 1.25rem 1.5rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
        min-height: 460px;
        max-height: 68vh;
        background: #ffffff;
      }

      .msg {
        display: flex;
        flex-direction: column;
        max-width: 80%;
        gap: 0.25rem;
      }

      .msg.user {
        align-self: flex-end;
        text-align: right;
      }

      .msg .role {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .bubble {
        padding: 0.8rem 0.9rem;
        border-radius: 16px;
        line-height: 1.45;
        white-space: pre-wrap;
        word-wrap: break-word;
        border: 1px solid var(--border);
      }

      .msg.user .bubble {
        background: var(--you);
        color: var(--youText);
        border-color: rgba(255, 255, 255, 0.25);
        border-top-right-radius: 6px;
      }

      .msg.assistant .bubble {
        background: var(--bot);
        color: var(--botText);
        border-top-left-radius: 6px;
      }

      .msg.loading .bubble {
        color: var(--muted);
        font-style: italic;
      }

      /* Input area */
      #input-area {
        border-top: 1px solid var(--border);
        padding: 1rem 1.25rem;
        background: #fff;
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      #user-input {
        flex: 1;
        padding: 0.85rem 0.9rem;
        border-radius: 14px;
        border: 1px solid var(--border);
        font-size: 1rem;
        outline: none;
        transition: border 0.15s ease, box-shadow 0.15s ease;
      }

      #user-input:focus {
        border-color: rgba(37, 99, 235, 0.55);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
      }

      button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
      }

      /* Footer hint */
      #hint {
        padding: 0.75rem 1.25rem 1rem;
        color: var(--muted);
        font-size: 0.85rem;
        border-top: 1px dashed var(--border);
        background: #fff;
      }

      code {
        background: rgba(17, 24, 39, 0.06);
        padding: 0.1rem 0.25rem;
        border-radius: 6px;
      }
    </style>
  </head>

  <body>
    <div id="container">
      <div id="header">
        <div id="title">
          <h1>⛷️ SkiSpecAI</h1>
          <p>Ski setup compatibility guidance (waist width, flex, bindings, DIN range)</p>
        </div>
        <div id="header-actions">
          <button class="btn" id="clear-btn" title="Clear conversation">Clear</button>
          <button class="btn primary" id="send-btn" title="Send message">Send</button>
        </div>
      </div>

      <div id="messages"></div>

      <div id="input-area">
        <input
          type="text"
          id="user-input"
          placeholder="Example: I’m an intermediate skier, 160 lbs, mostly groomers at a resort."
          autocomplete="off"
        />
      </div>

      <div id="hint">
        Tip: Include <b>ability</b> + <b>terrain</b>. If you’re a child, include <b>weight</b>.
        Use <code>Enter</code> to send.
      </div>
    </div>

    <script>
      const messages = document.getElementById("messages");
      const userInput = document.getElementById("user-input");
      const sendBtn = document.getElementById("send-btn");
      const clearBtn = document.getElementById("clear-btn");
      let sessionId = null;

      function addMessage(role, text, isLoading = false) {
        const div = document.createElement("div");
        div.className = "msg " + (role === "you" ? "user" : "assistant") + (isLoading ? " loading" : "");

        const roleLabel = document.createElement("div");
        roleLabel.className = "role";
        roleLabel.textContent = role;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        div.appendChild(roleLabel);
        div.appendChild(bubble);

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
      }

      async function send() {
        const text = userInput.value.trim();
        if (!text) return;

        userInput.value = "";
        userInput.focus();
        sendBtn.disabled = true;

        addMessage("you", text);
        const loading = addMessage("assistant", "Thinking...", true);

        try {
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text, session_id: sessionId }),
          });

          const contentType = res.headers.get("content-type") || "";
          if (!contentType.includes("application/json")) {
            const raw = await res.text();
            throw new Error("Non-JSON response. First chars: " + raw.slice(0, 60));
          }

          const data = await res.json();
          sessionId = data.session_id;

          loading.querySelector(".bubble").textContent = data.response;
          loading.classList.remove("loading");
        } catch (e) {
          loading.querySelector(".bubble").textContent = "Error: " + e.message;
          loading.classList.remove("loading");
        }

        sendBtn.disabled = false;
      }

      async function clearChat() {
        // Clear UI immediately
        messages.innerHTML = "";
        // Also clear backend session if we have one
        try {
          await fetch("/clear" + (sessionId ? `?session_id=${encodeURIComponent(sessionId)}` : ""), {
            method: "POST",
          });
        } catch (e) {
          // ignore
        }
        sessionId = null;
        addMessage("assistant", "Cleared. Ask me about your ski setup (ability + terrain).");
        userInput.focus();
      }

      sendBtn.addEventListener("click", send);
      clearBtn.addEventListener("click", clearChat);

      userInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });

      // starter message
      addMessage(
        "assistant",
        "Hi! Tell me your ability level and terrain (groomers/powder/park/touring). If a child, include weight."
      );
      userInput.focus();
    </script>
  </body>
</html>